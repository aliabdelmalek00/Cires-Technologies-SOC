version: "3.9"

networks:
  wazuh-net:
    external: true

services:
  ##############################
  # WAZUH MASTER
  ##############################
  wazuh.master:
    image: wazuh/wazuh:5.0.0
    hostname: wazuh-master
    
    ports:
      - target: 1515
        published: 1515
        protocol: tcp
        mode: host
      - target: 55000
        published: 55000
        protocol: tcp
        mode: host
      - target: 514
        published: 514
        protocol: udp
        mode: host
    environment:
      - NODE_TYPE=master
      - CLUSTER_NAME=wazuh-cluster
      - ELASTIC_URL=https://wazuh1.indexer:9200
      - ELASTIC_USER=admin
      - ELASTIC_PASSWORD=admin
    volumes:
      - /share/wazuh/manager/master/data:/var/ossec/data
      - /share/wazuh/manager/master/logs:/var/ossec/logs
      - /share/wazuh/manager/master/etc:/var/ossec/etc
      - /share/certs:/etc/ssl/certs:ro
    networks:
      - wazuh-net
    deploy:
      placement:
        constraints: [node.role == manager]

  ##############################
  # WAZUH WORKER
  ##############################
  wazuh.worker:
    image: wazuh/wazuh:5.0.0
    hostname: wazuh-worker
    
    environment:
      - NODE_TYPE=worker
      - CLUSTER_NAME=wazuh-cluster
      - ELASTIC_URL=https://wazuh1.indexer:9200
      - ELASTIC_USER=admin
      - ELASTIC_PASSWORD=admin
    volumes:
      - /share/wazuh/manager/worker/data:/var/ossec/data
      - /share/wazuh/manager/worker/logs:/var/ossec/logs
      - /share/wazuh/manager/worker/etc:/var/ossec/etc
      - /share/certs:/etc/ssl/certs:ro
    networks:
      - wazuh-net
    deploy:
      replicas: 1
      placement:
        constraints: [node.role == worker]

  ##############################
  # WAZUH DASHBOARD
  ##############################
  wazuh.dashboard:
    image: wazuh/wazuh-dashboard:5.0.0
    
    ports:
      - target: 443
        published: 443
        protocol: tcp
        mode: host
    environment:
      - ELASTIC_URL=https://wazuh1.indexer:9200
      - ELASTIC_USER=admin
      - ELASTIC_PASSWORD=admin
      - WAZUH_API_URL=https://wazuh.master:55000
    volumes:
      - /share/certs:/usr/share/wazuh-dashboard/certs:ro
      - /share/wazuh/dashboard/config:/usr/share/wazuh-dashboard/config:ro
    networks:
      - wazuh-net
    deploy:
      placement:
        constraints: [node.role == manager]

  ##############################
  # OPENSEARCH CLUSTER
  ##############################
  wazuh1.indexer:
    image: wazuh/wazuh-indexer:5.0.0
    
    environment:
      - cluster.name=wazuh-indexer-cluster
      - node.name=wazuh1
      - discovery.seed_hosts=wazuh1.indexer,wazuh2.indexer,wazuh3.indexer
      - cluster.initial_master_nodes=wazuh1.indexer,wazuh2.indexer,wazuh3.indexer
      - bootstrap.memory_lock=true
      - ELASTIC_PASSWORD=admin
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - /share/wazuh/indexer/wazuh1/data:/usr/share/wazuh-indexer/data
      - /share/certs:/usr/share/wazuh-indexer/certs:ro
    networks:
      - wazuh-net
    deploy:
      placement:
        constraints: [node.role == manager]

  wazuh2.indexer:
    image: wazuh/wazuh-indexer:5.0.0
    
    environment:
      - cluster.name=wazuh-indexer-cluster
      - node.name=wazuh2
      - discovery.seed_hosts=wazuh1.indexer,wazuh2.indexer,wazuh3.indexer
      - cluster.initial_master_nodes=wazuh1.indexer,wazuh2.indexer,wazuh3.indexer
      - bootstrap.memory_lock=true
      - ELASTIC_PASSWORD=admin
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - /share/wazuh/indexer/wazuh2/data:/usr/share/wazuh-indexer/data
      - /share/certs:/usr/share/wazuh-indexer/certs:ro
    networks:
      - wazuh-net

  wazuh3.indexer:
    image: wazuh/wazuh-indexer:5.0.0
    
    environment:
      - cluster.name=wazuh-indexer-cluster
      - node.name=wazuh3
      - discovery.seed_hosts=wazuh1.indexer,wazuh2.indexer,wazuh3.indexer
      - cluster.initial_master_nodes=wazuh1.indexer,wazuh2.indexer,wazuh3.indexer
      - bootstrap.memory_lock=true
      - ELASTIC_PASSWORD=admin
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - /share/wazuh/indexer/wazuh3/data:/usr/share/wazuh-indexer/data
      - /share/certs:/usr/share/wazuh-indexer/certs:ro
    networks:
      - wazuh-net

  ##############################
  # NGINX REVERSE PROXY
  ##############################
  nginx:
    image: nginx:latest
    
    ports:
      - target: 1514
        published: 1514
        protocol: tcp
        mode: host
    volumes:
      - /share/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /share/certs:/etc/nginx/certs:ro
    networks:
      - wazuh-net
    deploy:
      placement:
        constraints: [node.role == manager]
