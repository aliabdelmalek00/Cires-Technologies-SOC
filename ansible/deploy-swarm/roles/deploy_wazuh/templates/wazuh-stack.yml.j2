version: '3.8'

services:
  wazuh-master:
    image: wazuh/wazuh:5.0.0
    networks:
      - wazuh-net
    deploy:
      mode: replicated
      replicas: 1
    volumes:
      - wazuh-master-data:/var/ossec/data
    environment:
      - CLUSTER_NAME=wazuh-cluster
      - NODE_TYPE=master

  wazuh-manager:
    image: wazuh/wazuh:5.0.0
    networks:
      - wazuh-net
    deploy:
      mode: replicated
      replicas: 2
    volumes:
      - wazuh-manager-data:/var/ossec/data
    environment:
      - CLUSTER_NAME=wazuh-cluster
      - NODE_TYPE=manager
      - MASTER_NODE=wazuh-master

  wazuh-worker:
    image: wazuh/wazuh:5.0.0
    networks:
      - wazuh-net
    deploy:
      mode: replicated
      replicas: 1
    volumes:
      - wazuh-worker-data:/var/ossec/data
    environment:
      - CLUSTER_NAME=wazuh-cluster
      - NODE_TYPE=worker
      - MASTER_NODE=wazuh-master

  wazuh-indexer:
    image: wazuh/wazuh-indexer:5.0.0
    networks:
      - wazuh-net
    deploy:
      mode: replicated
      replicas: 3
    volumes:
      - wazuh-indexer-data:/usr/share/elasticsearch/data

  wazuh-dashboard:
    image: wazuh/wazuh-dashboard:5.0.0
    networks:
      - wazuh-net
    deploy:
      mode: replicated
      replicas: 1
    ports:
      - "443:443"
    volumes:
      - wazuh-dashboard-data:/usr/share/wazuh-dashboard/data
      - /share/certs:/etc/ssl/certs:ro
    environment:
      - ELASTICSEARCH_HOSTS=http://wazuh-indexer:9200

  wazuh-nginx:
    image: nginx:alpine
    networks:
      - wazuh-net
    deploy:
      mode: replicated
      replicas: 1
    ports:
      - "1514:1514"
    volumes:
      - /share/certs:/etc/nginx/certs:ro
      - /share/nginx.conf:/etc/nginx/conf.d/default.conf:ro

volumes:
  wazuh-master-data:
    driver: local
    driver_opts:
      type: nfs
      o: addr={{ nfs_server }},rw
      device: ":{{ nfs_share }}/wazuh-master-data"
  wazuh-manager-data:
    driver: local
    driver_opts:
      type: nfs
      o: addr={{ nfs_server }},rw
      device: ":{{ nfs_share }}/wazuh-manager-data"
  wazuh-worker-data:
    driver: local
    driver_opts:
      type: nfs
      o: addr={{ nfs_server }},rw
      device: ":{{ nfs_share }}/wazuh-worker-data"
  wazuh-indexer-data:
    driver: local
    driver_opts:
      type: nfs
      o: addr={{ nfs_server }},rw
      device: ":{{ nfs_share }}/wazuh-indexer-data"
  wazuh-dashboard-data:
    driver: local
    driver_opts:
      type: nfs
      o: addr={{ nfs_server }},rw
      device: ":{{ nfs_share }}/wazuh-dashboard-data"

networks:
  wazuh-net:
    external: true
