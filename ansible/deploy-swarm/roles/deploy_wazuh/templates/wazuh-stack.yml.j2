version: "3.9"
volumes:
  wazuh_data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=10.10.1.5,rw
      device: ":/srv/nfs"

networks:
  wazuh-net:
    external: true

services:

  wazuh-manager:
    image: wazuh/wazuh-manager:latest
    hostname: wazuh.manager
    networks:
      - wazuh-net
    deploy:
      mode: replicated
      replicas: 2
    restart: always
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 655360
        hard: 655360
    ports:
      - "1515:1515"
      - "514:514/udp"
      - "55000:55000"
    environment:
      - INDEXER_URL=https://wazuh1.indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=SecretPassword
      - FILEBEAT_SSL_VERIFICATION_MODE=full
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem
      - SSL_CERTIFICATE=/etc/ssl/wazuh.crt
      - SSL_KEY=/etc/ssl/wazuh.key
      - API_USERNAME=wazuh-wui
      - API_PASSWORD=MyS3cr37P450r.*-
    volumes:
      - /share/wazuh/manager/etc:/var/ossec/etc
      - /share/wazuh/manager/logs:/var/ossec/logs
      - /share/wazuh/manager/queue:/var/ossec/queue
      - /share/wazuh/manager/api-configuration:/var/ossec/api/configuration
      - /share/wazuh/manager/integrations:/var/ossec/integrations
      - /share/wazuh/manager/active-response:/var/ossec/active-response/bin
      - /share/wazuh/manager/agentless:/var/ossec/agentless
      - /share/wazuh/manager/wodles:/var/ossec/wodles
      - /share/wazuh/manager/filebeat-etc:/etc/filebeat
      - /share/wazuh/manager/filebeat-var:/var/lib/filebeat
      - /share/certs/wazuh.crt:/etc/ssl/wazuh.crt
      - /share/certs/wazuh.key:/etc/ssl/wazuh.key
      - /share/certs/root-ca.pem:/etc/ssl/root-ca.pem

  wazuh-indexer:
    image: wazuh/wazuh-indexer:latest
    hostname: wazuh.indexer
    networks:
      - wazuh-net
    deploy:
      mode: replicated
      replicas: 2
    environment:
      - cluster.name=wazuh-cluster
      - node.name=wazuh-indexer
      - discovery.seed_hosts=wazuh1.indexer,wazuh2.indexer
      - cluster.initial_master_nodes=wazuh1.indexer,wazuh2.indexer
    volumes:
      - /share/wazuh/indexer/data:/usr/share/elasticsearch/data

  wazuh-dashboard:
    image: wazuh/wazuh-dashboard:latest
    hostname: wazuh.dashboard
    networks:
      - wazuh-net
    deploy:
      mode: replicated
      replicas: 1
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=https://wazuh1.indexer:9200
      - ELASTICSEARCH_USERNAME=admin
      - ELASTICSEARCH_PASSWORD=SecretPassword
      - SSL_CERTIFICATE=/etc/ssl/wazuh.crt
      - SSL_KEY=/etc/ssl/wazuh.key
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem
    volumes:
      - /share/wazuh/dashboard/config:/usr/share/kibana/config
      - /share/certs/wazuh.crt:/etc/ssl/wazuh.crt
      - /share/certs/wazuh.key:/etc/ssl/wazuh.key
      - /share/certs/root-ca.pem:/etc/ssl/root-ca.pem

  wazuh-nginx:
    image: wazuh/wazuh-nginx:latest
    hostname: wazuh.nginx
    networks:
      - wazuh-net
    deploy:
      mode: replicated
      replicas: 1
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - /share/nginx/conf.d/default.d:/etc/nginx/conf.d/default.d:ro
      - /share/certs/wazuh.crt:/etc/ssl/wazuh.crt
      - /share/certs/wazuh.key:/etc/ssl/wazuh.key
