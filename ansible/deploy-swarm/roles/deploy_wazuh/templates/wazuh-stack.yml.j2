version: "3.9"

volumes:
  wazuh_manager_etc:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/share/wazuh/manager/etc"
  wazuh_manager_logs:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/share/wazuh/manager/logs"
  wazuh_manager_queue:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/share/wazuh/manager/queue"
  wazuh_manager_api_conf:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/share/wazuh/manager/api-configuration"
  wazuh_manager_integrations:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/share/wazuh/manager/integrations"
  wazuh_manager_active_response:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/share/wazuh/manager/active-response"
  wazuh_manager_agentless:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/share/wazuh/manager/agentless"
  wazuh_manager_wodles:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/share/wazuh/manager/wodles"
  wazuh_manager_filebeat_etc:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/share/wazuh/manager/filebeat-etc"
  wazuh_manager_filebeat_var:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/share/wazuh/manager/filebeat-var"
  wazuh_indexer_data:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/share/wazuh/indexer/data"
  wazuh_dashboard_config:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/share/wazuh/dashboard/config"
  wazuh_certs:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/share/wazuh/certs"
  wazuh_nginx_conf:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/wazuh/share/nginx/conf.d/default.conf"


networks:
  wazuh-net:
    external: true

services:

  wazuh-manager:
    image: wazuh/wazuh-manager:4.10.3
    hostname: wazuh.manager
    networks:
      - wazuh-net
    deploy:
      mode: replicated
      replicas: 2
    restart: always
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 655360
        hard: 655360
    ports:
      - "1515:1515"
      - "514:514/udp"
      - "55000:55000"
    environment:
      - INDEXER_URL=https://wazuh1.indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=SecretPassword
      - FILEBEAT_SSL_VERIFICATION_MODE=full
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem
      - SSL_CERTIFICATE=/etc/ssl/wazuh.crt
      - SSL_KEY=/etc/ssl/wazuh.key
      - API_USERNAME=wazuh-wui
      - API_PASSWORD=MyS3cr37P450r.*-
    volumes:
      - wazuh_manager_etc:/var/ossec/etc
      - wazuh_manager_logs:/var/ossec/logs
      - wazuh_manager_queue:/var/ossec/queue
      - wazuh_manager_api_conf:/var/ossec/api/configuration
      - wazuh_manager_integrations:/var/ossec/integrations
      - wazuh_manager_active_response:/var/ossec/active-response/bin
      - wazuh_manager_agentless:/var/ossec/agentless
      - wazuh_manager_wodles:/var/ossec/wodles
      - wazuh_manager_filebeat_etc:/etc/filebeat
      - wazuh_manager_filebeat_var:/var/lib/filebeat
      - wazuh_certs:/etc/ssl

  wazuh-indexer:
    image: wazuh/wazuh-indexer:4.10.3
    hostname: wazuh.indexer
    networks:
      - wazuh-net
    deploy:
      mode: replicated
      replicas: 2
    environment:
      - cluster.name=wazuh-cluster
      - node.name=wazuh-indexer
      - discovery.seed_hosts=wazuh1.indexer,wazuh2.indexer
      - cluster.initial_master_nodes=wazuh1.indexer,wazuh2.indexer
    volumes:
      - wazuh_indexer_data:/usr/share/elasticsearch/data

  wazuh-dashboard:
    image: wazuh/wazuh-dashboard:4.10.3
    hostname: wazuh.dashboard
    networks:
      - wazuh-net
    deploy:
      mode: replicated
      replicas: 1
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=https://wazuh1.indexer:9200
      - ELASTICSEARCH_USERNAME=admin
      - ELASTICSEARCH_PASSWORD=SecretPassword
      - SSL_CERTIFICATE=/etc/ssl/wazuh.crt
      - SSL_KEY=/etc/ssl/wazuh.key
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem
    volumes:
      - wazuh_dashboard_config:/usr/share/kibana/config
      - wazuh_certs:/etc/ssl

  wazuh-nginx:
    image: wazuh/wazuh-nginx:3.13.6_7.9.2
    hostname: wazuh.nginx
    networks:
      - wazuh-net
    deploy:
      mode: replicated
      replicas: 1
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - wazuh_nginx_conf:/etc/nginx/conf.d/default.d:ro
      - wazuh_certs:/etc/ssl
